name: CI - Patient Management

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

env:
  REGISTRY: docker.io
  IMAGE_REPO: 25rp20201-mbarushimana/patient-management

permissions:
  contents: read

jobs:
  actionlint:
    name: Workflow Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Lint GitHub Actions workflow
        uses: crazy-max/ghaction-actionlint@v5

  php_lint:
    name: PHP Code Style (PHPCS)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          tools: composer
          coverage: none
          extensions: mbstring, json
      - name: Install dependencies
        run: composer install --no-interaction --prefer-dist --no-progress || true
      - name: Install PHPCS globally
        run: composer global require squizlabs/php_codesniffer:^3
      - name: Run PHPCS
        run: ~/.composer/vendor/bin/phpcs --standard=PSR12 --extensions=php .

  static_analysis:
    name: Static Analysis (PHPStan)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          tools: composer
          coverage: none
      - name: Install dependencies
        run: composer install --no-interaction --prefer-dist --no-progress || true
      - name: Install PHPStan globally
        run: composer global require phpstan/phpstan:^1
      - name: Run PHPStan (fallback if no config)
        run: |
          if [ -f "phpstan.neon" ] || [ -f "phpstan.neon.dist" ]; then
            ~/.composer/vendor/bin/phpstan analyse --no-progress --memory-limit=512M
          else
            ~/.composer/vendor/bin/phpstan analyse --level=max --no-progress --memory-limit=512M .
          fi

  unit_tests:
    name: Unit Tests (PHPUnit Matrix)
    runs-on: ubuntu-latest
    strategy:
      matrix:
        php: [ '8.1', '8.2' ]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php }}
          tools: composer
          coverage: xdebug
      - name: Cache Composer
        uses: actions/cache@v4
        with:
          path: ~/.cache/composer/files
          key: composer-${{ runner.os }}-${{ matrix.php }}-${{ hashFiles('**/composer.lock') }}
          restore-keys: composer-${{ runner.os }}-${{ matrix.php }}-
      - name: Install deps
        run: composer install --no-interaction --prefer-dist --no-progress
      - name: Install PHPUnit globally (fallback)
        run: composer global require phpunit/phpunit:^10 || true
      - name: Run PHPUnit (auto-detect config)
        run: |
          if ls phpunit.xml* >/dev/null 2>&1; then
            vendor/bin/phpunit --coverage-clover coverage.xml || ~/.composer/vendor/bin/phpunit --coverage-clover coverage.xml
          else
            vendor/bin/phpunit || ~/.composer/vendor/bin/phpunit
          fi
      - name: Upload coverage
        if: success() && hashFiles('**/coverage.xml') != ''
        uses: actions/upload-artifact@v4
        with:
          name: coverage-${{ matrix.php }}
          path: coverage.xml

  dependency_audit:
    name: Dependency Audit (Composer)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          tools: composer
      - name: Install deps
        run: composer install --no-interaction --prefer-dist --no-progress || true
      - name: Composer audit
        run: composer audit --no-interaction || true

  secret_scan:
    name: Secret Scan (Gitleaks)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (full history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE || '' }}
        with:
          args: detect --no-banner -v --redact

  docker_build:
    name: Docker Build (no push)
    runs-on: ubuntu-latest
    needs: [ php_lint, static_analysis, unit_tests, dependency_audit, secret_scan ]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_REPO }}
          tags: |
            type=sha
            type=ref,event=branch
            type=raw,value=${{ github.ref_name }}-${{ github.run_number }}
      - name: Build image (no push)
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          push: false
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-to: type=inline

  container_scan:
    name: Container Scan (Trivy)
    runs-on: ubuntu-latest
    needs: [ docker_build ]
    steps:
      - name: Scan image with Trivy
        uses: aquasecurity/trivy-action@0.14.0
        with:
          image-ref: ${{ env.REGISTRY }}/${{ env.IMAGE_REPO }}:${{ github.sha }}
          format: table
          vuln-type: 'os,library'
          severity: HIGH,CRITICAL
      - name: Export Trivy report (JSON)
        uses: aquasecurity/trivy-action@0.14.0
        with:
          image-ref: ${{ env.REGISTRY }}/${{ env.IMAGE_REPO }}:${{ github.sha }}
          format: json
          output: trivy.json
      - name: Upload Trivy report
        uses: actions/upload-artifact@v4
        with:
          name: trivy-report
          path: trivy.json

  sbom_generate:
    name: SBOM Generate (Syft/Anchore)
    runs-on: ubuntu-latest
    needs: [ docker_build ]
    steps:
      - name: Generate SBOM from image
        uses: anchore/sbom-action@v0
        with:
          image: ${{ env.REGISTRY }}/${{ env.IMAGE_REPO }}:${{ github.sha }}
          format: spdx-json
          output: sbom.spdx.json
      - name: Upload SBOM
        uses: actions/upload-artifact@v4
        with:
          name: sbom-spdx
          path: sbom.spdx.json

  docker_push:
    name: Docker Push (main/develop only)
    runs-on: ubuntu-latest
    needs: [ container_scan, sbom_generate ]
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')
    steps:
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      - name: Tag local image
        run: |
          docker image tag ${{ env.REGISTRY }}/${{ env.IMAGE_REPO }}:${{ github.sha }} ${{ env.REGISTRY }}/${{ env.IMAGE_REPO }}:${{ github.ref_name }}-latest
          docker image tag ${{ env.REGISTRY }}/${{ env.IMAGE_REPO }}:${{ github.sha }} ${{ env.REGISTRY }}/${{ env.IMAGE_REPO }}:${{ github.ref_name }}-${{ github.run_number }}
      - name: Push tags
        run: |
          docker push ${{ env.REGISTRY }}/${{ env.IMAGE_REPO }}:${{ github.sha }}
          docker push ${{ env.REGISTRY }}/${{ env.IMAGE_REPO }}:${{ github.ref_name }}-latest
          docker push ${{ env.REGISTRY }}/${{ env.IMAGE_REPO }}:${{ github.ref_name }}-${{ github.run_number }}